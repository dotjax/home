#!/usr/bin/env bash
set -euo pipefail

echo "=== Fedora Maintenance Script ==="
echo "Running as: $(whoami)"
echo ""

# Show initial disk space
echo "Disk space before cleanup:"
df -h / | grep -E '^Filesystem|/'
echo ""

# Clean journal logs
echo "Cleaning journal logs (retaining 3 days, max 500MB)..."
sudo journalctl --vacuum-time=3d --vacuum-size=500M

# Flatpak cache clean up
rm -rf "$HOME/.cache/flatpak"
find "$HOME/.var/app" -path '*/.cache' -prune -exec rm -rf {} + 2>/dev/null || true
sudo rm -rf /var/cache/flatpak

# Targeted cache cleanup (safe)
echo "Cleaning user-level caches (targeted)..."
# Clean browser caches older than 30 days
find ~/.cache/mozilla ~/.cache/chromium ~/.cache/google-chrome -type f -mtime +30 -delete 2>/dev/null || true
# Clean old thumbnails
find ~/.cache/thumbnails -type f -mtime +30 -delete 2>/dev/null || true
# Clean pip cache
rm -rf ~/.cache/pip/* 2>/dev/null || true
# Clean temp directories in cache
find ~/.cache -type f -name "*.tmp" -delete 2>/dev/null || true

# Check for old kernels
echo "Checking for old kernels..."
KERNEL_COUNT=$(dnf list installed kernel 2>/dev/null | grep -c "^kernel\." || echo "0")
if [ "$KERNEL_COUNT" -gt 3 ]; then
    echo "Found $KERNEL_COUNT kernels installed (limit should be 3)."
    echo "Consider running: sudo dnf remove $(dnf repoquery --installonly --latest-limit=-3 -q)"
else
    echo "Kernel count is within limits ($KERNEL_COUNT)."
fi

# Show final disk space
echo ""
echo "Disk space after cleanup:"
df -h / | grep -E '^Filesystem|/'
echo ""

echo "=== Maintenance Complete! ==="

